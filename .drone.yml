---
kind: pipeline
name: build

steps:
  - name: test
    image: mazzolino/docker-shellspec:0.1
    volumes:
      - name: dockersock
        path: /var/run
    when:
      event:
        - push

  - name: build & push PR
    image: thegeeklab/drone-docker-buildx:20.11@sha256:327b6fb15dc841cf80c7c429f60d695efd7c7a476fe363afac25a58befd4c203
    settings:
      repo: mazzolino/restic
      tags:
        - pr-${DRONE_PULL_REQUEST}
      platforms:
        - linux/amd64
        - linux/arm64
        - linux/armhf
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      event:
        - push
      ref:
        include:
          - refs/heads/**
          - refs/pull/**
      branch:
        exclude:
          - master

  - name: build & push release
    image: thegeeklab/drone-docker-buildx:20.11@sha256:327b6fb15dc841cf80c7c429f60d695efd7c7a476fe363afac25a58befd4c203
    settings:
      auto_tag: true
      repo: mazzolino/restic
      platforms:
        - linux/amd64
        - linux/arm64
        - linux/armhf
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      event:
        - push
        - tag
      branch:
        - master
 
trigger:
  event:
    exclude:
      - pull_request

services:
  - name: docker
    image: docker:20.10-dind
    commands:
      - dockerd
    privileged: true
    volumes:
      - name: dockersock
        path: /var/run

volumes:
  - name: dockersock
    temp: {}
---
kind: signature
hmac: cf364dd4911654bb21891c3a4a946a3d468ca1996a0ae123b010127da341d96e

...
